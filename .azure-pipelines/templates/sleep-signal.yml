# templates/sleep-signal.yml
# Template for putting Windows/Linux host to sleep

parameters:
  stageName: ''
  displayName: ''
  dependsOn: []
  condition: ''

stages:
  - stage: ${{ parameters.stageName }}
    displayName: ${{ parameters.displayName }}
    dependsOn: ${{ parameters.dependsOn }}
    condition: ${{ parameters.condition }}

    jobs:
      - job: SendSleepSignal
        displayName: Send Sleep Signal
        pool:
          name: ${{ parameters.poolName }}
        timeoutInMinutes: 10
        steps:
          - checkout: none

          - script: |
              if [ -z "$HOST_IP" ] || [ -z "$HOST_PORT" ] || [ -z "$HOST_SECRET" ]; then
                  echo "❌ One or more required environment variables are missing."
                  exit 1
              fi

              URL="http://${HOST_IP}:${HOST_PORT}/sleep/"
              echo "Sending POST to the host"
              HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" \
                  -X POST \
                  -H "X-Auth: ${HOST_SECRET}" \
                  -H "Content-Length: 0" \
                  "$URL")

              echo "HTTP response code: $HTTP_CODE"
              if [[ "$HTTP_CODE" =~ ^2 ]]; then
                  echo "✅ Sleep signal sent successfully."
              else
                  echo "❌ Failed to send sleep signal (HTTP $HTTP_CODE)"
                  exit 1
              fi
            displayName: 'Send Sleep Signal'
            condition: succeeded()
            env:
              HOST_IP: $(HOST_IP)
              HOST_PORT: $(HOST_PORT)
              HOST_SECRET: $(HOST_SECRET)
