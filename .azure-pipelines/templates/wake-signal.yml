# templates/wake-signal.yml
# Template for waking up the Windows/Linux host

parameters:
  stageName: ''
  displayName: ''
  dependsOn: []
  condition: ''

stages:
  - stage: ${{ parameters.stageName }}
    displayName: ${{ parameters.displayName }}
    dependsOn: ${{ parameters.dependsOn }}
    condition: ${{ parameters.condition }}

    jobs:
      - job: SendWakeUpSignal
        displayName: Send Wake-Up Signal
        pool:
          name: ${{ parameters.poolName }}
        timeoutInMinutes: 10
        steps:
          - checkout: none

          - script: |
              macAddress="${HOST_MAC}"
              macAddressCleaned=$(echo "$macAddress" | tr -d ':-')
              if [ ${#macAddressCleaned} -ne 12 ]; then
                  echo "❌ Invalid MAC address format"
                  exit 1
              fi

              magicPacket=""
              for i in {1..6}; do
                  magicPacket="${magicPacket}ff"
              done

              for i in {1..16}; do
                  magicPacket="${magicPacket}${macAddressCleaned}"
              done

              if [ -n "$HOST_IP" ]; then
                  echo "$magicPacket" | xxd -r -p | nc -w1 -u "$HOST_IP" 9
                  echo "✅ Sent directly to $HOST_IP:9"
              fi

              echo "$magicPacket" | xxd -r -p | nc -b -w1 -u 255.255.255.255 9
              echo "✅ Sent to global broadcast (255.255.255.255:9)"
            displayName: 'Send Wake-Up Signal'
            condition: succeeded()
            env:
              HOST_MAC: $(HOST_MAC)
              HOST_IP: $(HOST_IP)
